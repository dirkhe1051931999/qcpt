/**
 * 自动生成 global.d.ts
 * 扫描 src/components 目录，查找所有包含 types.ts 的组件
 * 自动生成 Vue GlobalComponents 类型声明
 */

import { readdirSync, existsSync, readFileSync, writeFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const ROOT_DIR = join(__dirname, '..');
const COMPONENTS_DIR = join(ROOT_DIR, 'src/components');
const OUTPUT_FILE = join(ROOT_DIR, 'src/global.d.ts');

/**
 * 将 kebab-case 转换为 PascalCase
 * j-q-button -> JQButton
 */
function kebabToPascal(str) {
  return str
    .split('-')
    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
    .join('');
}

/**
 * 从 types.ts 文件中提取导出的类型名称
 */
function extractExportedTypes(typesPath) {
  const content = readFileSync(typesPath, 'utf-8');
  const types = {
    props: null,
    slots: null,
    emits: null,
    templateProps: null,
  };

  // 匹配 export interface XXXProps
  const propsMatch = content.match(/export\s+interface\s+(\w+Props)\s/);
  if (propsMatch) types.props = propsMatch[1];

  // 匹配 export interface XXXSlots
  const slotsMatch = content.match(/export\s+interface\s+(\w+Slots)\s/);
  if (slotsMatch) types.slots = slotsMatch[1];

  // 匹配 export interface XXXEmits
  const emitsMatch = content.match(/export\s+interface\s+(\w+Emits)\s/);
  if (emitsMatch) types.emits = emitsMatch[1];

  // 匹配 export interface XXXTemplateProps
  const templatePropsMatch = content.match(/export\s+interface\s+(\w+TemplateProps)\s/);
  if (templatePropsMatch) types.templateProps = templatePropsMatch[1];

  return types;
}

/**
 * 从 types.ts 提取组件的 JSDoc 描述
 */
function extractComponentDescription(typesPath, componentName) {
  const content = readFileSync(typesPath, 'utf-8');
  
  // 尝试从 Props 接口的注释中提取描述
  const propsMatch = content.match(/\/\*\*[\s\S]*?\*\/\s*export\s+interface\s+\w+Props/);
  if (propsMatch) {
    const comment = propsMatch[0];
    const descMatch = comment.match(/@description\s+(.+)/);
    if (descMatch) return descMatch[1].trim();
  }
  
  return `${componentName} 组件`;
}

/**
 * 扫描组件目录，收集所有有 types.ts 的组件
 */
function scanComponents() {
  const components = [];
  
  const dirs = readdirSync(COMPONENTS_DIR, { withFileTypes: true })
    .filter(dirent => dirent.isDirectory())
    .map(dirent => dirent.name);

  for (const dir of dirs) {
    const typesPath = join(COMPONENTS_DIR, dir, 'types.ts');
    
    if (existsSync(typesPath)) {
      const componentName = kebabToPascal(dir);
      const types = extractExportedTypes(typesPath);
      const description = extractComponentDescription(typesPath, componentName);
      
      // 只有当组件有 Props 类型时才添加
      if (types.props) {
        components.push({
          name: componentName,
          dir,
          types,
          description,
        });
      }
    }
  }

  return components.sort((a, b) => a.name.localeCompare(b.name));
}

/**
 * 生成 global.d.ts 内容
 */
function generateGlobalTypes(components) {
  const imports = [];
  const globalDeclarations = [];

  for (const comp of components) {
    const { name, dir, types, description } = comp;
    const importPath = `./components/${dir}/types`;

    // 生成导入语句
    const importTypes = [];
    if (types.templateProps) {
      importTypes.push(types.templateProps);
    } else if (types.props) {
      importTypes.push(types.props);
    }
    if (types.slots) importTypes.push(types.slots);
    if (types.emits) importTypes.push(types.emits);

    if (importTypes.length > 0) {
      imports.push(`import type {\n  ${importTypes.join(',\n  ')},\n} from '${importPath}';`);
    }

    // 生成 GlobalComponents 声明
    const propsType = types.templateProps || types.props;
    const slotsType = types.slots || '{}';
    const emitsType = types.emits || '{}';

    globalDeclarations.push(`    /**
     * ${name} - ${description}
     */
    ${name}: new () => {
      $props: ${propsType};
      $slots: ${slotsType};
      $emit: ${emitsType};
    };`);
  }

  const content = `/**
 * qcpt 全局组件类型声明
 * 
 * This file is auto-generated by scripts/generate-global-types.js
 * Do not edit manually, changes will be overwritten on next build
 * 
 * Compatible with Vue 3.2+
 */

${imports.join('\n\n')}

declare module 'vue' {
  export interface GlobalComponents {
${globalDeclarations.join('\n\n')}
  }
}

export {};
`;

  return content;
}

/**
 * 主函数
 */
function main() {
  console.log('Scanning components directory...');
  const components = scanComponents();
  
  if (components.length === 0) {
    console.log('No components with types.ts found');
    return;
  }

  console.log(`Found ${components.length} component(s):`);
  components.forEach(c => console.log(`  - ${c.name} (${c.dir})`));

  console.log('\nGenerating global.d.ts...');
  const content = generateGlobalTypes(components);
  writeFileSync(OUTPUT_FILE, content, 'utf-8');
  
  console.log(`Done! Generated ${OUTPUT_FILE}`);
}

main();

